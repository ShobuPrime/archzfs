name: Build RC Packages

on:
  push:
    tags:
      - 'rc-*'  # Triggers on tags like rc-2.4.0-rc3
  workflow_dispatch:  # Allows manual triggering
    inputs:
      version:
        description: 'OpenZFS RC version (e.g., 2.4.0-rc3)'
        required: true

jobs:
  build-rc:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel python python-setuptools python-cffi dkms git wget

      - name: Configure build version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (e.g., rc-2.4.0-rc3 -> 2.4.0-rc3)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#rc-}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building OpenZFS RC $VERSION"

      - name: Build RC packages
        run: |
          # Create a non-root user for makepkg
          useradd -m builder
          chown -R builder:builder .

          # Run build script
          su - builder -c "cd $(pwd) && sudo ./build-openzfs-version.sh ${{ steps.version.outputs.version }} rc"

          # Build utils package
          su - builder -c "cd $(pwd)/packages/_utils/zfs-utils-rc && makepkg -s --noconfirm"

          # Build DKMS package
          su - builder -c "cd $(pwd)/packages/dkms/zfs-dkms-rc && makepkg -s --nodeps --noconfirm"

          # Copy packages to root (exclude debug packages)
          for pkg in packages/_utils/zfs-utils-rc/*.pkg.tar.zst; do
            [ -f "$pkg" ] && echo "$pkg" | grep -qv debug && cp -v "$pkg" . || true
          done
          for pkg in packages/dkms/zfs-dkms-rc/*.pkg.tar.zst; do
            [ -f "$pkg" ] && echo "$pkg" | grep -qv debug && cp -v "$pkg" . || true
          done

          ls -lh *.pkg.tar.zst

      - name: Create pacman repository database
        run: |
          # Create repository database
          repo-add archzfs-rc.db.tar.gz *.pkg.tar.zst

          # Create file list
          ls -1 *.pkg.tar.zst > package-list.txt
          echo "Built RC packages:"
          cat package-list.txt

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          cat > release-notes.md <<'EOF'
          # OpenZFS ${{ steps.version.outputs.version }} RC - DKMS Packages for Arch Linux

          ## Installation

          ### Method 1: Direct Install

          ```bash
          # Download packages
          wget https://github.com/${{ github.repository }}/releases/download/rc-latest/zfs-utils-rc-*.pkg.tar.zst
          wget https://github.com/${{ github.repository }}/releases/download/rc-latest/zfs-dkms-rc-*.pkg.tar.zst

          # Install
          sudo pacman -U zfs-*.pkg.tar.zst

          # Enable ZFS services
          sudo systemctl enable zfs.target
          ```

          ### Method 2: Pacman Repository

          Add to `/etc/pacman.conf`:

          ```ini
          [archzfs-rc]
          SigLevel = Optional TrustAll
          Server = https://github.com/${{ github.repository }}/releases/download/rc-latest
          ```

          Then install:

          ```bash
          sudo pacman -Sy archzfs-rc/zfs-dkms-rc archzfs-rc/zfs-utils-rc
          sudo systemctl enable zfs.target
          ```

          ## Packages Included

          EOF

          for pkg in *.pkg.tar.zst; do
            size=$(du -h "$pkg" | cut -f1)
            echo "- \`$pkg\` ($size)" >> release-notes.md
          done

          cat >> release-notes.md <<'EOF'

          ## OpenZFS Version

          - **Version**: ${{ steps.version.outputs.version }}
          - **Type**: RELEASE CANDIDATE
          - **Source**: https://github.com/openzfs/zfs/releases/tag/zfs-${{ steps.version.outputs.version }}

          ## Features

          - ✅ DKMS packages (kernel-independent)
          - ✅ Auto-rebuild on kernel updates
          - ✅ Compatible with Arch Linux rolling release
          - ✅ Fixed for modern Arch (/usr/lib paths)
          - ⚠️  **Release Candidate** - Use for testing or kernel compatibility

          ## Documentation

          - [Complete Guide](https://github.com/${{ github.repository }}/blob/master/Claude.md)
          - [Quick Start](https://github.com/${{ github.repository }}/blob/master/Claude.md#appendix-a-quick-start-guide)
          - [Build Safety](https://github.com/${{ github.repository }}/blob/master/Claude.md#appendix-b-build-safety-and-system-cleanliness)

          ## Important Notes

          ### mkinitcpio Hook

          **Only add the `zfs` hook to `/etc/mkinitcpio.conf` if your root filesystem is on ZFS.**

          - **BTRFS/ext4 root**: Do NOT add the hook. ZFS loads automatically when needed.
          - **ZFS root**: Add `zfs` to HOOKS array.

          ### ZFS Pool Auto-Import

          Enable systemd services after installation:

          ```bash
          sudo systemctl enable zfs.target
          ```

          ZFS pools do NOT use `/etc/fstab`. They auto-import via systemd services.
          EOF

          cat release-notes.md

      - name: Create or Update RC Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: rc-latest
          name: "OpenZFS RC - Latest (${{ steps.version.outputs.version }})"
          files: |
            *.pkg.tar.zst
            archzfs-rc.db.tar.gz
            archzfs-rc.db
            archzfs-rc.files.tar.gz
            archzfs-rc.files
            package-list.txt
          body_path: release-notes.md
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
